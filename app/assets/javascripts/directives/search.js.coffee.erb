angular.module('BoxApp').directive 'search', ['$timeout', ($timeout) ->
  setupTimer = true

  restrict: 'E'
  replace: true

  link: (scope, element, attrs) ->
    scope.$watch 'query', ->
      $timeout.cancel timer if timer?
      return setupTimer = true unless setupTimer
      timer = $timeout( ->
        if scope.query
          scope.showResults = true
          scope.search()
        else
          scope.showResults = false
      , 600)

  controller: ($scope, $element) ->
    $scope.click = (item) ->
      $scope.query = item.name
      setupTimer = false
      $scope.showResults = false

  templateUrl: '<%= asset_path "search.html" %>'
]