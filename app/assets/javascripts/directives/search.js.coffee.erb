angular.module('BoxApp').directive 'search', ['$timeout', '$injector', ($timeout, $injector) ->
  setupTimer = true

  restrict: 'E'
  replace: true

  scope:
    onSelect: '='
    searchFor: '@'

  link: (scope, element, attrs) ->
    scope.$watch 'query', ->
      $timeout.cancel timer if timer?
      return setupTimer = true unless setupTimer
      timer = $timeout( ->
        if scope.query
          scope.showResults = true
          scope.search()
        else
          scope.showResults = false
      , 600)

  controller: ($scope, $element) ->
    $scope.search = ->
      $injector.get($scope.searchFor).search($scope.query).then (result) ->
        $scope.items = result

    $scope.click = (item) ->
      $scope.query = item.name
      setupTimer = false
      $scope.showResults = false
      $scope.onSelect? item

  templateUrl: '<%= asset_path "search.html" %>'
]